stages:
  - test
  - build
  - deploy

Preliminary Test:
  stage: test
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  tags:
    - linux
  image: ubuntu:18.10
  before_script:
    - apt-get update -qy
    - apt-get install -y build-essential avr-libc binutils-arm-none-eabi binutils-avr dfu-programmer dfu-util gcc gcc-arm-none-eabi git libnewlib-arm-none-eabi unzip wget zip
    - wget http://blog.zakkemble.net/download/avr-gcc-8.3.0-x64-linux.tar.bz2
    - bzip2 -d avr-gcc-8.3.0-x64-linux.tar.bz2
    - avr-gcc --version
    - uname -a
  script:
    - make test:all
    - make planck/rev6:default planck/rev5:default

QMK Firmware Defaults:
  stage: deploy
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  tags:
    - linux
  image: ubuntu:18.10
  before_script:
    - apt-get update -qy
    - apt-get install -y build-essential avr-libc binutils-arm-none-eabi binutils-avr dfu-programmer dfu-util gcc gcc-arm-none-eabi gcc-avr git libnewlib-arm-none-eabi unzip wget zip
    - avr-gcc --version
    - uname -a
  script:
    - make test:all
    - make all:default -j16

Drashna Firmware:
  stage: build
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  tags:
    - linux
  image: ubuntu:18.10
  before_script:
    - apt-get update -qy
    - apt-get install -y build-essential avr-libc binutils-arm-none-eabi binutils-avr dfu-programmer dfu-util gcc gcc-arm-none-eabi gcc-avr git libnewlib-arm-none-eabi unzip wget zip
    - avr-gcc --version
  script:
    - make keebio/iris/rev2:drashna:production keebio/iris/rev2:drashna_old:production ergodox_ez:drashna ergodox_ez:drashna_glow keebio/viterbi/rev1:drashna:production orthodox/rev1:drashna:production orthodox/rev3:drashna:production crkbd:drashna:production planck/light:drashna:production planck/rev6:drashna fractal:drashna:production primekb/prime_m:drashna:production -j16 --output-sync
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - ./*.hex
      - ./*.bin
    expire_in: 1 month
