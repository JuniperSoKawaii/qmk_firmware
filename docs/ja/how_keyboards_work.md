# キーの登録方法とコンピュータによる解釈

<!---
  original document: 0.9.32:docs/how_keyboards_work.md
  git diff 0.9.32 HEAD -- docs/how_keyboards_work.md | cat
-->

このファイルでは、USB でキーボードがどのように動作するかの概念を学習できます。ファームウェアを直接変更することで何が期待できるかをより良く理解することができます。

## 概略図

特定のキーを1つ入力するたびに、発生するアクションのチェーンがあります:

```text
+------+         +-----+       +----------+      +----------+     +----+
| User |-------->| Key |------>| Firmware |----->| USB wire |---->| OS |
+------+         +-----+       +----------+      +----------+     +----+
```

この図は何が起こっているかを非常に単純に示したものです。詳細については次のセクションで説明します。

## 1. キーを押す

キーを押すたびに、キーボードのファームウェアはこのイベントを登録することができます。
キーが押され、保持され、放された時に登録することができます。

これは通常キー押下の定期的な走査で発生します。この速度は多くの場合、メカニカルキーの応答時間、キー押下を転送するプロトコル(ここでは USB HID)、使用されるソフトウェアによって制限されます。

## 2. ファームウェアが送信するもの

[HID 仕様](https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf)は、キーボードが実際に USB を介して送信し、適切に認識される機会を得るものを示します。これには、`0x00` から `0xE7` までの単純な番号である事前定義されたスキャンコードが含まれます。ファームウェアはスキャンコードをキーボードのそれぞれのキーに割り当てます。

ファームウェアは実際の文字を送信せず、スキャンコードだけを送信します。
従って、ファームウェアを修正することで、指定されたキーについて USB を介してどのスキャンコードが送信されるかを修正することができます。

## 3. イベント入力やカーネルが何を行うか
                                               j
*スキャンコード*は、[マスターの 60-keyboard.hwdb](https://github.com/systemd/systemd/blob/master/hwdb.d/60-keyboard.hwdb) キーボードに依存する*キーコード*にマップされます。このマッピングが無いと、オペレーティングシステムは有効なキーコードを受信せず、キー押下で何も有用なことができません。

## 4. オペレーティングシステムがすること

キーコードがオペレーティングシステムに到達すると、ソフトウェアの一部はキーボードのレイアウトによって、実際の文字と照合しなければなりません。例えば、レイアウトが QWERTY に設定されている場合、照合テーブルの例は以下の通りです:

| keycode | character |
|---------|-----------|
| 0x04 | a/A |
| 0x05 | b/B |
| 0x06 | c/C |
| ... | ... |
| 0x1C | y/Y |
| 0x1D | z/Z |
| ... | ... |

## ファームウェアに戻る

(独自のものを作成していない限り)レイアウトは一般的に固定されているため、ファームウェアは実際にレイアウト名で直接キーコードを呼び出して、作業を簡単にします。これが、実際に QWERTY の `0x04` を表す `KC_A` で行われることです。完全なリストは[キーコード](ja/keycodes.md)で見つけることができます。

## 送信できる文字のリスト

ショートカットを別として、限られたレイアウトにマップされた限られたキーコードのセットは、**指定されたキーに割り当てることができる文字のリストは、レイアウト内に存在するものだけである**ことを意味します。

例えば、QWERTY US レイアウトがあり、1つのキーを割り当てて `€` (ユーロ通貨記号)を生成する場合、QWERTY US レイアウトはそのようなマッピングを持たないため、そうすることができないことを意味します。QWERTY UK レイアウト、あるいは QWERTY US International を使ってそれを修正することができます。

全ての Unicode を含むキーボードレイアウトがなぜ考案されていないのか疑問に思うかもしれません。USB を介して利用可能なキーコードの数の制限により、このようなことは許可されません。

## (おそらく) Unicode 文字を入力する方法

ファームウェアに *一連のキー* を送信させて、目的のオペレーティングシステムに[ソフトウェア Unicode 入力方法](https://en.wikipedia.org/wiki/Unicode_input#Hexadecimal_input)を使うことができます。このようにして、OSで定義されたレイアウトとは無関係に文字を効率的に入力することができます。

ただし、以下のような複数の欠点があります:

- 同時に、特定の OS に縛られます (OS を変更する時に再コンパイルする必要があります);
- 特定の OS 内で、全てのソフトウェアが動作するわけではありません;
- 一部のシステムでは Unicode のサブセットに制限されます。
