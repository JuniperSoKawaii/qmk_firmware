# バックライト

多くのキーボードは、キースイッチを通して、あるいはその下に配置された個々のLEDによって、バックライトキーをサポートします。This feature is distinct from both the [RGB underglow](feature_rgblight.md) and [RGB matrix](feature_rgb_matrix.md) features as it usually allows for only a single colour per switch, though you can obviously install multiple different single coloured LEDs on a keyboard.

QMKはこれらのLEDを特定の比率、*Pulse Width Modulation*または PWM として知られている技術で急速にオンおよびオフを切り替えることで、これらのLEDの輝度を制御できます。PWM信号のデューティサイクルを変えることで、調光の錯覚を起こすことができます。

MCUはGPIOピンにのみ大量の電流を供給することができます。MCUから直接バックライトに給電せずに、バックライトピンはLEDへの電力を切り替えるトランジスタあるいはMOSFETに接続されます。

## 使用法

ほとんどのキーボードはサポートしている場合デフォルトでバックライトが有効になっていますが、もし機能しない場合は`rules.mk`が以下を含んでいることを確認してください:

```make
BACKLIGHT_ENABLE = yes
```

## キーコード
有効にすると、以下のキーコードを使ってバックライトレベルを変更することができます。

| キー | 説明 |
|---------|------------------------------------------|
| `BL_TOGG` | バックライトをオンあるいはオフする |
| `BL_STEP` | バックライトレベルを循環する |
| `BL_ON` | バックライトを最大輝度に設定する |
| `BL_OFF` | バックライトをオフにする |
| `BL_INC` | バックライトレベルを上げる |
| `BL_DEC` | バックライトレベルを下げる |
| `BL_BRTG` | バックライトのブレスを切り替える |

## AVRドライバ

### 注意事項

ハードウェア PWMは以下の表に従ってサポートされます:

| バックライトピン | AT90USB64/128 | ATmega16/32U4 | ATmega16/32U2 | ATmega32A | ATmega328P |
|-------------|-------------|-------------|-------------|---------|----------|
| `B1` |  |  |  |  | Timer 1 |
| `B2` |  |  |  |  | Timer 1 |
| `B5` | Timer 1 | Timer 1 |  |  |  |
| `B6` | Timer 1 | Timer 1 |  |  |  |
| `B7` | Timer 1 | Timer 1 | Timer 1 |  |  |
| `C4` | Timer 3 |  |  |  |  |
| `C5` | Timer 3 |  | Timer 1 |  |  |
| `C6` | Timer 3 | Timer 3 | Timer 1 |  |  |
| `D4` |  |  |  | Timer 1 |  |
| `D5` |  |  |  | Timer 1 |  |

他の全てのピンはソフトウェアPWMを使います。[オーディオ](feature_audio.md)機能が無効あるいは1つのタイマだけを使っている場合は、バックライトPWMはハードウェアタイマによって引き起こすことができます:

| オーディオピン | オーディオタイマ | ソフトウェアPWMタイマ |
|---------|-----------|------------------|
| `C4` | Timer 3 | Timer 1 |
| `C5` | Timer 3 | Timer 1 |
| `C6` | Timer 3 | Timer 1 |
| `B5` | Timer 1 | Timer 3 |
| `B6` | Timer 1 | Timer 3 |
| `B7` | Timer 1 | Timer 3 |

両方のタイマーがオーディオのために使われている場合、バックライトPWMはハードウェアタイマを使いませんが、代わりにマトリックス スキャンの間に引き起こされます。この場合、PWMの計算は十分なタイミングの精度で呼ばれないかもしれないため、ブレスはサポートされず、バックライトも点滅するかもしれません。

### AVR設定

バックライトの挙動を変更するには、`config.h`の中でそれらを`#define`します:

| 定義 | デフォルト | 説明 |
|---------------------|-------------|-------------------------------------------------------------------------------------------------------------|
| `BACKLIGHT_PIN` | `B7` | LEDを制御するピン。自身のキーボードを設計している場合を除き、これを変更する必要はないはずです |
| `BACKLIGHT_PINS` | *定義なし* | 実験的: 詳細は以下を見てください |
| `BACKLIGHT_LEVELS` | `3` | 輝度のレベルの数 (オフを除いて最大 31) |
| `BACKLIGHT_CAPS_LOCK` | *定義なし* | バックライトを使って Capsロックのインジケータを有効にする (専用LEDの無いキーボードのため) |
| `BACKLIGHT_BREATHING` | *定義なし* | サポートされる場合は、バックライトのブレスを有効にする |
| `BREATHING_PERIOD` | `6` | 1つのバックライトの "ブレス" の長さの秒 |
| `BACKLIGHT_ON_STATE` | `0` | バックライトが "オン" の時のバックライトピンの状態 - 高の場合は`1`、低の場合は`0` |

### バックライト オン状態

ほとんどのバックライトの回路はNチャンネルのMOSFETあるいはNPNトランジスタによって駆動されます。これは、トランジスタを *オン*にしてLEDを点灯させるには、ゲートまたはベースに接続されているバックライトピンを*高*に駆動する必要があることを意味します。
ただし、PチャンネルのMOSFETあるいはPNPトランジスタが使われる場合があります。この場合、トランジスタがオンになった時、ピンは代わりに*低*で駆動されます。

この機能は`BACKLIGHT_ON_STATE`定義を使ってキーボードレベルで設定されます

### 複数のバックライトピン

ほとんどのキーボードは、全てのバックライトLEDを制御するたった1つのバックライトピンを持ちます (特にバックライトがハードウェアPWMピンに接続されている場合)。
ソフトウェアPWMでは、複数のバックライトピンを定義することができます。これらすべてのピンはPWMデューティサイクル時に同時にオンおよびオフになります。
この機能により、例えばCapsロックLED (またはその他の制御可能なLED)の輝度を、バックライトの他のLEDと同じレベルに設定することができます。Capsロックの代わりに LCTRL をマップし、Capsロックがオンの時にCapsロックLEDをアクティブにする代わりにバックライトの一部にする必要がある場合に便利です。

複数のバックライトピンをアクティブにするには、`config.h`に次のようなものを追懐する必要があります:

```c
#define BACKLIGHT_LED_COUNT 2
#undef BACKLIGHT_PIN
#define BACKLIGHT_PINS { F5, B2 }
```

### ハードウェアPWM実装

バックライト用にサポートされているピンを使う場合、QMKはPWM信号を出力するように設定されたハードウェアタイマを使います。タイマーは0にリセットする前に`ICRx` (デフォルトでは `0xFFFF`) までカウントします。
希望の輝度が計算され、`OCRxx` レジスタ内に格納されます。カウンタがこの値まで達すると、バックライトピンは低になり、カウンタがリセットされると再び高になります。
このように`OCRxx` は基本的にLEDのデューティサイクルを制御し、従って輝度を制御します。`0x0000`は完全にオフで、 `0xFFFF`は完全にオンです。

ブレス効果はカウンタがリセットされるたびに呼び出される`TIMER1_OVF_vect`の割り込みハンドラ、秒間あたりおよそ244回、を登録することで行えます。
このハンドラ内で、増分カウンタの値が事前に計算された輝度曲線にマップされます。ブレスをオフにするには、割り込みハンドラを単純に無効にし、輝度をEEPROMに格納されているレベルに再設定します。

### ソフトウェアPWM実装

`BACKLIGHT_PIN` がハードウェアバックライトピンに設定されていない場合、QMKはソフトウェア割り込みを引き起こすように設定されているハードウェアタイマを使います。タイマーは0にリセットする前に`ICRx` (デフォルトでは `0xFFFF`) までカウントします。
0に再設定すると、CPUはLEDをオンにするOVF (オーバーフロー)割り込みを発火し、デューティサイクルを開始します。
希望の輝度が計算され、`OCRxx` レジスタ内に格納されます。カウンタがこの値に達すると、CPUは Compare Output 一致割り込みを発火し、LEDをオフにします。
このように `OCRxx`は基本的にLEDのデューティサイクルを制御し、従って輝度を制御します。 `0x0000` は完全にオフで、 `0xFFFF`は完全にオンです。

ブレス効果はハードウェアPWM実装と同じです。

## ARMドライバ

### 注意事項

現在のところハードウェアPWMのみがサポートされ、自動設定は提供されません。

?> STMF072 サポートは調査中です。

### ARM設定

バックライトの挙動を変更するには、`config.h`の中でそれらを`#define`します:

| 定義 | デフォルト | 説明 |
|------------------------|-------------|-------------------------------------------------------------------------------------------------------------|
| `BACKLIGHT_PIN` | `B7` | LEDを制御するピン。自身のキーボードを設計している場合を除き、これを変更する必要はないはずです |
| `BACKLIGHT_PWM_DRIVER` | `PWMD4` | 使用するPWMドライバ。ピンからPWMタイマへのマッピングについては、STデータシートを見てください。自身のキーボードを設計している場合を除き、これを変更する必要はないはずです |
| `BACKLIGHT_PWM_CHANNEL` | `3` | 使用するPWMチャンネル。ピンからPWMチャンネルへのマッピングについては、STデータシートを見てください。自身のキーボードを設計している場合を除き、これを変更する必要はないはずです |
| `BACKLIGHT_PAL_MODE` | `2` | 使用するピンの代替機能。ピンのAFマッピングについてはSTデータシートを見てください。自身のキーボードを設計している場合を除き、これを変更する必要はないはずです |
| `BACKLIGHT_LEVELS` | `3` | 輝度のレベルの数 (オフを除いて最大 31) |
| `BACKLIGHT_CAPS_LOCK` | *定義なし* | バックライトを使って Capsロックのインジケータを有効にする (専用LEDの無いキーボードのため) |
| `BACKLIGHT_BREATHING` | *定義なし* | サポートされる場合は、バックライトのブレスを有効にする |
| `BREATHING_PERIOD` | `6` | 1つのバックライトの "ブレス" の長さの秒 |

## バックライト機能

| 機能 | 説明 |
|----------|-----------------------------------------------------------|
| `backlight_toggle()` | バックライトをオンあるいはオフする |
| `backlight_enable()` | バックライトをオンにする |
| `backlight_disable()` | バックライトをオフにする |
| `backlight_step()` | バックライトレベルを循環する |
| `backlight_increase()` | バックライトレベルを上げる |
| `backlight_decrease()` | バックライトレベルを下げる |
| `backlight_level(x)` | バックライト レベルを0からその値に設定する |
|  | `BACKLIGHT_LEVELS` |
| `get_backlight_level()` | 現在のバックライトレベルを返す |
| `is_backlight_enabled()` | バックライトが現在オンかどうかを返す |

### バックライトのブレス機能

| 機能 | 説明 |
|----------|----------------------------------------------------------|
| `breathing_toggle()` | バックライトのブレスをオンまたはオフにする |
| `breathing_enable()` | バックライトのブレスをオンにする |
| `breathing_disable()` | バックライトのブレスをオフにする |
