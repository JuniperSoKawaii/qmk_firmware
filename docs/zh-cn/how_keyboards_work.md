# 计算机是如何注册并解释键的

在本文中，你将会学习键盘通过USB工作的概念，
你将会更好的理解直接改变你的固件可以得到什么。


## 示意图

当你敲击某个键时，将会发生以下一系列事情
如下所示：

``` text
+------+         +-----+       +-----+      +-------+     +----------+
| 用户 |-------->| 键  |------>| 固件 |----->| USB线 |---->| 操作系统 |
+------+         +-----+       +-----+      +-------+     +----------+
```

示意图简化的阐释了发生的事情，接下来的章节中将会详细解释。


## 1. 按下某个键

每当你按下某个键，你键盘的固件就记录了这个事件。<!--TODO:翻译成记录的这个词是：register，也可能翻译成"注册"，暂定"记录"，有更好的请改正-->
可以被记录的事件包括按下，保持和释放。

这通常伴随着周期性按键扫描发生。此速度通常受机械键响应时间，协议传输(此时为USB HID协议)耗时和固件影响。

## 2. 固件发送了什么

[HID规范](https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf)说明了实际上键盘发送了什么才有可能被正确识别。这包括一个`0x00` 到 `0xE7`的简单数字组成的预定义键盘扫描码列表。固件为键盘的每个键分配一个扫描码。

固件并不发送实际的字母或字符，仅发送扫描码。
因此，通过定制固件你可以自定义某个键向USB发送什么扫描码。


## 3. 内核的输入处理做了什么

*扫描码*与*键码*的对应关系因键盘而异，详见[60-keyboard.hwdb at Master](https://github.com/systemd/systemd/blob/master/hwdb.d/60-keyboard.hwdb)。没有这个映射，操作系统将不会收到有效的键码也不能做出应有的反应。<!--TODO:这节题目实在不会翻译，直接翻译根本无法理解，一定是由于我对这节理解不透。不过文档说的不清楚，这个"the Event Input/Kernel"是个啥也不知道>

## 4. 操作系统做了什么

当键码到达操作系统，一些软件必须基于键盘布局将它与实际字符匹配
比如
如果你的布局设置为QWERTY，简化对应表如下：

| 键码 | 字符 |
|------|------|
| 0x04 | a/A |
| 0x05 | b/B |
| 0x06 | c/C |
| ... | ... |
| 0x1C | y/Y |
| 0x1D | z/Z |
| ... | ... |

## 再谈固件开发

由于布局通常是固定的(除非是你自己创立的)，固件可以直接通过布局名称调用键码，为您提供方便。这就可以解释对于QWERTY布局`KC_A`实际上代表`0x04`。 全部列表详见 [键码](zh-cn/keycodes.md)。

## 你可以发送的字符的列表

抛开快捷键不谈，只有有限的键码也只能映射到有限的布局，也就是说**你可以分配给某个键的字符的列表只能是布局中存在的字符**。

比如，也就是说假如您有美国的QWERTY布局，并且您想让一个键对应`€` (欧元符号)，您将根本无法实现，因为美式QWERTY布局不可以有这样的映射。您可以使用英式QWERTY布局或者美式国际QWERTY。

你可能想知道为什么没有设计一个包含所有Unicode的键盘布局，这是因为通过USB传输的键码数量有限，根本不允许那样。

## 如何输入Unicode字符(可能方案)

你可以让固件发送*一系列键*来使用目标操作系统的[软件Unicode输入方法](https://en.wikipedia.org/wiki/Unicode_input#Hexadecimal_input)，从而有效地独立于操作系统中定义的布局输入字符。

然而，它确实有诸多缺点：

 - 一次仅能适配一个操作系统(在更换操作系统时要重新编译)；
 - 对于某个操作系统来说, 并不适配所有软件；
 - 在某些操作系统中仅限于Unicode的一个子集。

<!--源文件： https://raw.githubusercontent.com/qmk/qmk_firmware/d5316e9714e6bd661ece1bf364dce1e9fd79988c/docs/how_keyboards_work.md
    源提交哈希：d5316e9714e6bd661ece1bf364dce1e9fd79988c-->
<!--翻译时间:20200302-22:37(GMT+8)-->
