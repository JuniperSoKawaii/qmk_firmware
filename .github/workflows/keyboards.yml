name: PR keyboards/keymaps

on:
  pull_request:
    paths-ignore:
    - 'docs/**'
    - 'util/**'
    - 'tests/**'

jobs:
  build:
    runs-on: ubuntu-latest

    container: qmkfm/base_container

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
        submodules: 'recursive'

    - uses: trilom/file-changes-action@v1.2.4
      id: file_changes
      with:
        output: '\n'

    - name: Print git info
      run: |
        git rev-parse --short HEAD
        echo ${{ github.event.pull_request.base.sha }}
        echo '${{ steps.file_changes.outputs.files}}'

    - name: Prepare ccache
      id: ccache_prepare
      shell: 'bash {0}'
      run: |
        string(TIMESTAMP current_date "%Y-%m-%d-%H;%M;%S")
        message("::set-output name=timestamp::${current_date}")

    - uses: actions/cache@v2
      with:
        path: |
          .ccache/
        key: ${{ runner.os }}-ccache-${{ github.ref }}-${{ steps.ccache_prepare.outputs.timestamp }}
        # Restoring: From current branch, otherwise from base branch.
        restore-keys: |
          ${{ runner.os }}-ccache-${{ github.ref }}
          ${{ runner.os }}-ccache-${{ github.base_ref }}

    - name: Build 
      shell: 'bash {0}'
      env:
        MAKEFLAGS: '-j --output-sync'
      run: |
        apt-get update && apt-get install --no-install-recommends -y ccache
        export PATH="/usr/lib/ccache:$PATH"
        export CCACHE_DIR=.ccache
        make all:default
        ccache -s
