#include "oled_util.h"
#include "encoder_util.h"
#include "split_util.h"
#include "rgb_util.h"

// Keylogger
#define KEYLOG_LEN 3
char     keylog_str[KEYLOG_LEN + 1] = {"   "};
uint16_t log_timer              = 0;
bool     keylog_reset = true;
// clang-format off
const char code_to_name[45] = {
    ' ', ' ', ' ', ' ', 'a', 'b', 'c', 'd', 'e', 'f',
    'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p',
    'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
    '1', '2', '3', '4', '5', '6', '7', '8', '9', '0',
    20,  19,  27,  26,  22
};

void add_keylog(uint16_t keycode) {
    if ((keycode >= QK_MOD_TAP && keycode <= QK_MOD_TAP_MAX) || (keycode >= QK_LAYER_TAP && keycode <= QK_LAYER_TAP_MAX)) {
        keycode = keycode & 0xFF;
    }

    if (keycode < 45) {
        if (!keylog_reset) {
            for (uint8_t i = KEYLOG_LEN - 1; i > 0; i--) {
                keylog_str[i] = keylog_str[i - 1];
            }
        }
        keylog_str[0] = code_to_name[keycode];
        keylog_reset = false;
        log_timer = timer_read();
    }
}

void update_log(void) {
    if (!keylog_reset && timer_elapsed(log_timer) > 30000) { // 30 seconds
        sprintf(keylog_str, "   ");
        keylog_reset = true;
    }
}

void render_keylogger(void) {

    oled_write_P(PSTR(" "), false);
    oled_write_P(PSTR(">"), true);
    if (keylog_reset) {
        bool blink = (timer_read() % 1000) < 500;
        oled_write_P(blink ? PSTR("_  ") : PSTR("   "), true);
    } else {
        oled_write(keylog_str,  true);
    }
    oled_write_P(PSTR(" "), false);
}

void render_status_bar(void) {
    uint8_t modifiers = get_mods();
    led_t   led_state = host_keyboard_led_state();
    oled_write_P(PSTR("\325\326"), (modifiers & MOD_MASK_SHIFT));
    oled_write_P(PSTR("\327\330"), (modifiers & MOD_MASK_CTRL));
    oled_write_P(PSTR("\331\332"), (modifiers & MOD_MASK_ALT));
    oled_write_P(PSTR("\333\334"), (modifiers & MOD_MASK_GUI));
    oled_write_P(PSTR("\275\276"), led_state.caps_lock);

    if (isLeftHand) {
        oled_write_P(PSTR(" \265\266\267\227\230 "), false);
    } else {
        oled_write_P(PSTR(" \225\226\267\270\271 "), false);
    }

    oled_write_P(PSTR("\52:"), false);
    render_rgb_animation_number();
}

void render_rgb_animation_number(void) {
    int  rgb_mode = rgblight_get_mode();
    char rgb_mode_str[10];
    sprintf(rgb_mode_str, (rgb_mode < 10) ? "0%d" : "%d", rgb_mode);
    oled_write(rgb_mode_str, false);
}

void render_kyria_logo(void) {
    static const char PROGMEM kyria_logo[] = {
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,192,224,240,112,120, 56, 60, 28, 30, 14, 14, 14,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7, 14, 14, 14, 30, 28, 60, 56,120,112,240,224,192,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,192,224,240,124, 62, 31, 15,  7,  3,  1,128,192,224,240,120, 56, 60, 28, 30, 14, 14,  7,  7,135,231,127, 31,255,255, 31,127,231,135,  7,  7, 14, 14, 30, 28, 60, 56,120,240,224,192,128,  1,  3,  7, 15, 31, 62,124,240,224,192,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,240,252,255, 31,  7,  1,  0,  0,192,240,252,254,255,247,243,177,176, 48, 48, 48, 48, 48, 48, 48,120,254,135,  1,  0,  0,255,255,  0,  0,  1,135,254,120, 48, 48, 48, 48, 48, 48, 48,176,177,243,247,255,254,252,240,192,  0,  0,  1,  7, 31,255,252,240,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,255,255,255,  0,  0,  0,  0,  0,254,255,255,  1,  1,  7, 30,120,225,129,131,131,134,134,140,140,152,152,177,183,254,248,224,255,255,224,248,254,183,177,152,152,140,140,134,134,131,131,129,225,120, 30,  7,  1,  1,255,255,254,  0,  0,  0,  0,  0,255,255,255,  0,  0,  0,  0,255,255,  0,  0,192,192, 48, 48,  0,  0,240,240,  0,  0,  0,  0,  0,  0,240,240,  0,  0,240,240,192,192, 48, 48, 48, 48,192,192,  0,  0, 48, 48,243,243,  0,  0,  0,  0,  0,  0, 48, 48, 48, 48, 48, 48,192,192,  0,  0,  0,  0,  0,
        0,  0,  0,255,255,255,  0,  0,  0,  0,  0,127,255,255,128,128,224,120, 30,135,129,193,193, 97, 97, 49, 49, 25, 25,141,237,127, 31,  7,255,255,  7, 31,127,237,141, 25, 25, 49, 49, 97, 97,193,193,129,135, 30,120,224,128,128,255,255,127,  0,  0,  0,  0,  0,255,255,255,  0,  0,  0,  0, 63, 63,  3,  3, 12, 12, 48, 48,  0,  0,  0,  0, 51, 51, 51, 51, 51, 51, 15, 15,  0,  0, 63, 63,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 48, 48, 63, 63, 48, 48,  0,  0, 12, 12, 51, 51, 51, 51, 51, 51, 63, 63,  0,  0,  0,  0,  0,
        0,  0,  0,  0, 15, 63,255,248,224,128,  0,  0,  3, 15, 63,127,255,239,207,141, 13, 12, 12, 12, 12, 12, 12, 12, 30,127,225,128,  0,  0,255,255,  0,  0,128,225,127, 30, 12, 12, 12, 12, 12, 12, 12, 13,141,207,239,255,127, 63, 15,  3,  0,  0,128,224,248,255, 63, 15,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  3,  7, 15, 62,124,248,240,224,192,128,  1,  3,  7, 15, 30, 28, 60, 56,120,112,112,224,224,225,231,254,248,255,255,248,254,231,225,224,224,112,112,120, 56, 60, 28, 30, 15,  7,  3,  1,128,192,224,240,248,124, 62, 15,  7,  3,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  3,  7, 15, 14, 30, 28, 60, 56,120,112,112,112,224,224,224,224,224,224,224,224,224,224,224,224,224,224,224,224,112,112,112,120, 56, 60, 28, 30, 14, 15,  7,  3,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
    };
    oled_write_raw_P(kyria_logo, sizeof(kyria_logo));
}

void render_qmk_logo(void) {
    static const char PROGMEM qmk_logo[] = {
        0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x8b,0x8c,0x8d,0x8e,0x8f,0x90,0x91,0x92,0x93,0x94,
        0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,0xab,0xac,0xad,0xae,0xaf,0xb0,0xb1,0xb2,0xb3,0xb4,
        0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xcb,0xcc,0xcd,0xce,0xcf,0xd0,0xd1,0xd2,0xd3,0xd4,0};

    oled_write_P(qmk_logo, false);
}

void render_layer() {
    oled_write_P(PSTR("\335\336:"), false);

    switch (get_highest_layer(layer_state)) {
        case _QWERTY:
            oled_write_P(PSTR("\272 QWERTY"), false);
            break;
        case _NUMBERS:
            oled_write_P(PSTR("\273 NUMPAD"), false);
            break;
        case _LOWER:
            oled_write_P(PSTR("\233 LOWER "), false);
            break;
        case _RAISE:
            oled_write_P(PSTR("\234 RAISE "), false);
            break;
        case _ADJUST:
            oled_write_P(PSTR("\274 ADJUST"), false);
            break;
        default:
            oled_write_P(PSTR(" Undef"), false);
    }
}

#ifdef ENCODER_ENABLE
void render_encoder() {
    oled_write_P(PSTR("\277\237:"), false);

    switch (encoder_mode) {
        case ENC_MODE_VOLUME:
            oled_write_P(PSTR("\016"), false);
            break;
        case ENC_MODE_WORD_NAV:
            oled_write_P(PSTR("\177"), false);
            break;
        case ENC_MODE_LEFT_RIGHT:
            oled_write_P(PSTR("\032"), false);
            break;
        case ENC_MODE_UP_DOWN:
            oled_write_P(PSTR("\027"), false);
            break;
        case ENC_MODE_PAGING:
            oled_write_P(PSTR("\022"), false);
            break;
        case ENC_MODE_UNDO:
            oled_write_P(PSTR("\176"), false);
            break;
        default:
            oled_write_P(PSTR("?"), false);
    }
}
#endif


// Render
void render_master(void) {
    render_qmk_logo();
    oled_write_ln_P(PSTR("---------------------"), false);

    render_layer();

    // render_keylogger();
    oled_write_P(PSTR("      "), false); // keylogger disabled

    // Encoder state
    render_encoder();

    oled_write_ln_P(PSTR(""), false);
    render_status_bar();
}

void render_slave(void) {
    render_kyria_logo();
}

void render_status(void) {
    update_log();
    if (is_keyboard_master()) {
        render_master();
    } else {
        render_slave();
    }
}
